import psycopg2
from psycopg2 import Error,  sql
import os as os
import prettytable

def connect_db():
    try:
        connection = psycopg2.connect(user="postgres",
                                      password="neina776",
                                      host="127.0.0.1",
                                      port="5432",
                                      database="PROJEK GEDE")
        cursor = connection.cursor()
        return connection, cursor
    except (Exception, Error) as error:
        return None, None
def commit_db(connection, cursor):
    connection.commit()
    boolean = cursor.rowcount
    cursor.close()
    connection.close()
    return boolean
def clear_terminal():
    os.system('cls')

# FITUR CUSTOMER
def Katalog_Benih(id_user):
    connection, cursor = connect_db()
    clear_terminal()
    print()
    print('1. Tampilkan semua Katalog Menu')
    print()
    print("  Filter Berdasarkan Kategori ")
    print("2. Harga Terendah")
    print("3. Harga Tertinggi")
    print("4. Stok Tersedia")
    print("5. Kembali ke Menu Customer")
    print()
    pilih = input('Pilih Menu anda 1/2/3/4/5/6: ')
    
    QUERY_BASE = """
        SELECT
        b.id_benih, b.nama_benih, k.nama_kategori, b.harga, b.kadaluarsa,
        SUM(r.jumlah_produksi) as stok    
        FROM benih b
        JOIN kategori_benih k ON b.id_kategori_benih = k.id_kategori_benih
        LEFT JOIN riwayat_produksi r ON b.id_benih = r.id_benih
        GROUP BY b.id_benih, b.nama_benih, k.nama_kategori, b.harga, b.kadaluarsa 
    """
    
    try: 
        if pilih == '1':
            query = QUERY_BASE
        elif pilih == "2":
            query = QUERY_BASE + " ORDER BY b.harga ASC"    
        elif pilih == "3":
            query = QUERY_BASE + " ORDER BY b.harga DESC"
        elif pilih == "4":
            query =  """
            SELECT
            b.id_benih, b.nama_benih, k.nama_kategori, b.harga, b.kadaluarsa,
            SUM(r.jumlah_produksi) as stok    
            FROM benih b
            JOIN kategori_benih k ON b.id_kategori_benih = k.id_kategori_benih
            LEFT JOIN riwayat_produksi r ON b.id_benih = r.id_benih
            GROUP BY b.id_benih, b.nama_benih, k.nama_kategori, b.harga, b.kadaluarsa 
            HAVING SUM(r.jumlah_produksi) > 0 
            ORDER BY b.nama_benih ASC
        """
        elif pilih == "5":
            clear_terminal()
            return menu_customer(id_user)
        else:
            print("Pilihan tidak valid.")
            return Katalog_Benih(id_user)

        if pilih in ['1', '2', '3', '4']:
            cursor.execute(query)
            data = cursor.fetchall()
        else:
            data = []

        clear_terminal()
        print("\n" + "="*75)
        print("                   üå± KATALOG BENIH üå±")
        print("="*75)
        print("="*75)
        print("     Gunakan ID Benih untuk menambahkan ke keranjang belanja Anda.")
        print("="*75)

        if not data:
            if pilih in ['1', '2', '3', '4']:
                print("Belum ada benih yang tersedia.")
            
            print("="*75 + "\n")
            return menu_customer(id_user)
            
        kategori_sekarang = None

        for row in data:
            id_benih, nama_benih, nama_kategori, harga, kadaluarsa, stok = row

            if nama_kategori != kategori_sekarang:
                kategori_sekarang = nama_kategori
                print(f"\nüìÇ Kategori: {nama_kategori}")
                print("-"*75)
                print(f"{'ID Benih':^10} {'Nama Benih':^25} {'Harga':^10} {'Tanggal Kadaluarsa':^20} {'Stok':^7}")
                print("-"*75)
            
            if kadaluarsa is not None:
                tanggal_str = kadaluarsa.strftime("%Y-%m-%d")
            else:
                tanggal_str = "N/A"
                
            stok_display = stok if stok is not None else 0
            
            id_benih_display = id_benih if id_benih is not None else ""
            nama_benih_display = nama_benih if nama_benih is not None else ""
            harga_display = harga if harga is not None else ""

            print(f"{id_benih_display:^10} {nama_benih_display:^25} {harga_display:^10} {tanggal_str:^20} {stok_display:^7}")
            
            stok = stok_display
            
        print()
        kelas = input('pilih 1 untuk kembali dan 2 untuk pilih benih: ')
        if kelas == '1':
          clear_terminal()
          Katalog_Benih(id_user)
        elif kelas == '2':
          connection, cursor = connect_db()
          aku = input('masukkan id benih yg mau dibeli: ')
          kmu = input('masukkan jumlah benih yg dibeli: ')

          sql_get_keranjang = "SELECT id_keranjang FROM users WHERE id_user = %s"
          cursor.execute(sql_get_keranjang, (id_user,))
          result = cursor.fetchone()
            

          if result:
            id_keranjang = result[0]
          else:
            # keranjang baru 
            sql_create_keranjang = """
            INSERT INTO keranjang (id_user, status, created_at) 
            VALUES (%s, 'active', NOW()) 
            RETURNING id_keranjang
            """
            cursor.execute(sql_create_keranjang, (id_user,))
            id_keranjang = cursor.fetchone()[0]
            print(f"Keranjang baru dibuat: {id_keranjang}")

          sql_detail = """
                        INSERT INTO detail_keranjang (id_keranjang, id_benih, quantity)
                        VALUES (%s, %s, %s)
                        """
                        
          cursor.execute("SELECT id_keranjang FROM users WHERE id_user = %s", (id_user,))
          keranjang = cursor.fetchone()                
                        
          data_detail = (id_keranjang, aku, kmu) 
          cursor.execute(sql_detail, data_detail)
          connection.commit()  
          print()
          print()
          print()
          
          pergi = input('Benih sudah dimasukkan ke keranjang silahkan tekan enter untuk pergi ke menu keranjang')
          if pergi == '':
            clear_terminal()
            Keranjang_Belanja(id_user)
          else :
            clear_terminal()
            print('PILIHAN TIDAK VALID KEMBALI KE MENU CUSTOMER')
            menu_customer(id_user)
          

    except Exception as e :
        print(f"Terjadi Error: {e}")
        print()
        print('=== DATA TIDAK VALID KEMBALI KE MENU ===')
        print()
        menu_customer(id_user)
        print()
    finally:
        commit_db(connection, cursor)
        

def Keranjang_Belanja(id_user):
    id_pesanan_baru = None
    connection, cursor = connect_db()
    
    print()
    print('1. Tampilkan Keranjang Belanja')
    print('2. Kembali Menu Customer')
    pilih = input('Pilih Menu anda 1/2: ')
    try:
      if pilih == '1':
            clear_terminal()
            print("===============================               WELCOME TO KERANJANG               ===============================")
            print()
            query = """
                SELECT d.id_detail_keranjang, b.nama_benih, b.harga, d.quantity, (b.harga * d.quantity) AS total_harga
                FROM detail_keranjang d
                JOIN benih b ON d.id_benih = b.id_benih
                WHERE d.id_keranjang = %s
                ORDER BY d.id_detail_keranjang 
            """
            cursor.execute(query, (id_user,))
            results = cursor.fetchall()

            if not results:
                print()
                print("Keranjang belanja Anda kosong.")
                return menu_customer(id_user)
            
            else:
              keranjang = []
              total_semua = 0
          
            for row in results:
                print("===============================          Detail Keranjang Belanja Anda           ===============================")
                print()
                print(f"ID DETAIL   : {row[0]}       Nama Benih   : {row[1]}     harga: {row[2]}    Jumlah: {row[3]}     Total Harga: {row[4]}")
                print()
                print("================================================================================================================")  
                print()

                keranjang.append({
                'id_detail': row[0],
                'nama_benih': row[1],
                'harga': int(row[2]),
                'jumlah': int(row[3]),
                'total_harga': int(row[4])
                  })
                total_semua += int(row[4])
            print(f"{'TOTAL KERANJANG':<100} Rp {int(total_semua):>}")
            print("="*112)
            
            print("\nMasukkan ID DETAIL yang ingin dibeli (pisahkan dengan spasi):")
            try:
                pilihan = input(">>:  ").strip()
                if not pilihan:
                  print("Tidak ada item yang dipilih!")
                  return pilihan
            
                id_detail = [int(x.strip()) for x in pilihan.split()]
                
                dipilih = [item for item in keranjang if int(str(item['id_detail']).strip()) in id_detail]
                
                if not dipilih:
                    print("Tidak ada item yang valid dipilih!")
                    clear_terminal()
                    pilihan
                
                print(f"\n‚úÖ {len(dipilih)} item dipilih untuk checkout!")
                print("\n" + "="*100)
                print(" " * 40 + "üõí CHECKOUT")
                print("="*100)
                print(f"{'ID':<8} {'NAMA BENIH':<25} {'HARGA':<12} {'QTY':>4} {'SUB TOTAL':>15}")
                print("-" * 100)
                    
                total_bayar = 0
                for item in dipilih:
                    print(f"{item['id_detail']:<8} {item['nama_benih']:<25} Rp {item['harga']:>3} {item['jumlah']:>7}        Rp {item['total_harga']:>7}")
                    total_bayar += item['total_harga']
                    print()
                    print("-" * 100)
                    print(f"{'TOTAL YANG HARUS DIBAYAR':<58} Rp {total_bayar:>3}")
                    print("="*100)
                    
                    cursor.execute("SELECT id_keranjang FROM users WHERE id_user = %s", (id_user,))
                    keranjang = cursor.fetchone()
                    if not keranjang:
                        print(" Keranjang tidak ditemukan!")
                    
                    print("\n" + "="*50)
                    print("INFORMASI PENGIRIMAN & PEMBAYARAN")
                    print("="*50)
                    
                    metode_pembayaran = input("Metode Pembayaran Cash/Kartu): ").strip()
                    
                    if not metode_pembayaran :
                        print(" Metode pembayaran wajib diisi!")
                        metode_pembayaran
                    
                    
                    konfir = input('Anda yakin ingin untuk Membeli item ini ? ya/tidak: ').strip().lower()
                    if konfir == 'ya':
                      id_pesanan = """
                                  INSERT INTO pesanan (tanggal_pesanan, id_user)
                                  VALUES (NOW(), %s)
                                  RETURNING id_pesanan;
                                  """
                      data_pesan = (id_user,)
                      cursor.execute(id_pesanan, data_pesan)
                    
                      result = cursor.fetchone()
                      id_pesanan_baru = result[0]

                      list = [item['id_detail'] for item in dipilih]
                      for id_detail_keranjang in list:
                        info = """
                                          SELECT id_benih, quantity
                                          FROM detail_keranjang
                                          WHERE id_detail_keranjang = %s
                                          """
                        cursor.execute(info, (id_detail_keranjang,))
                        item_data = cursor.fetchone()
                        
                        if item_data:
                            id_benih_beli = item_data[0]
                            qty_dibeli = item_data[1]
                            

                            sql_update_stok = """
                                              UPDATE riwayat_produksi
                                              SET jumlah_produksi = jumlah_produksi - %s
                                              WHERE id_benih = %s;
                                  """
                            cursor.execute(sql_update_stok, (qty_dibeli, id_benih_beli))
                            print(f"DEBUG: Mencoba UPDATE Benih ID {id_benih_beli} sebanyak {qty_dibeli}.")
                      
                      hold = ', '.join(['%s'] * len(id_detail))
                      sql_delete = f"""
                      DELETE FROM detail_keranjang
                      WHERE id_detail_keranjang IN ({hold});
                                  """
                      cursor.execute(sql_delete, tuple(id_detail))
                      

                      print()
                      print("="*50)
                      print("PEMBELIAN BERHASIL!")
                      print(f" No. Pesanan: #{id_pesanan_baru}")
                      print(f" Total: Rp {total_bayar}")
                      print("üõí Keranjang sekarang KOSONG") 
                      print()
                      pergi = input('Silahkan tekan enter untuk pergi kembali ke menu customer')
                      if pergi == '':
                        clear_terminal()
                        menu_customer(id_user)
                      else :
                        clear_terminal()
                        print('PILIHAN TIDAK VALID KEMBALI KE MENU CUSTOMER')
                        menu_customer(id_user)
            
            except ValueError:
                  print(" Input tidak valid! Harus angka.")
                  clear_terminal()
                  pilihan
                  
    except Exception as e :
        print(f"Terjadi Error: {e}")
        print('=== DATA TIDAK VALID KEMBALI KE MENU ===')
        print()
        menu_customer(id_user)
    finally:
        commit_db(connection, cursor)
        print()

def Riwayat_Transaksi(id_user):
    connect_db()
    connection, cursor = connect_db()
    print()
    print('1. Tampilkan Fitur Transaksi')
    print('2. Kembali Menu Customer')
    pilih = input('Pilih Menu anda 1/2: ')
    try:
      clear_terminal()
      if pilih == '1':
          # checkout detail = join
          query = """
                  SELECT t.tanggal_transaksi, b.nama_benih, d.quantity, d.quantity*b.harga AS Total_bayar,
                        k.nama_kabupaten, c.nama_kecamatan, s.nama_desa
                  FROM transaksi t
                  JOIN detail_pesanan d ON d.id_pesanan = t.id_pesanan
                  JOIN pesanan p ON p.id_pesanan = d.id_pesanan
                  JOIN benih b ON b.id_benih = d.id_benih 
                  JOIN users u ON p.id_user = u.id_user  
                  JOIN alamat a ON u.id_user = a.id_user
                  JOIN kabupaten k ON a.id_alamat = k.id_alamat
                  JOIN kecamatan c ON a.id_alamat = c.id_alamat
                  JOIN desa s ON a.id_alamat = c.id_alamat
                  WHERE p.id_user = %s
                  ORDER BY t.tanggal_transaksi DESC, t.id_transaksi;
          """
          cursor.execute(query, (id_user,))
          results = cursor.fetchall()
          print()
          print("=== WELCOME TO RIWAYAT TRANSAKSI ===")
          print()
          if not results:
              print()
              print("Tidak ada riwayat transaksi.")
              print()
              menu_customer(id_user)
          else:
              for row in results:
                tanggal = str(row[0]) 
                nama = row[1]
                qty = row[2]
                harga = row[3]
                kabupaten = row[4]
                kecamatan = row[5]
                desa = row [6]

                print(f"| {tanggal:<10} | {nama:<20} | {qty:<5} | {harga:<10} | {kabupaten:<15} | {kecamatan:<15} | {desa:<15} |")
                print("-" * 65)
      
          balik = input('Tekan enter untuk kembali ke menu customer')
          if balik == '':
            clear_terminal()
            menu_customer(id_user)
          else :
            menu_customer(id_user)
      
      elif pilih == '2':
        menu_customer(id_user)
      
      else:
        print('=== PILIHAN TIDAK VALID ===')
    except Exception as e :
        print(f"Terjadi Error: {e}")
    finally:
          commit_db(connection, cursor)
    print()
    print()
      
# FITUR ADMIN
def generate_laporan(id_user):
# benih, sama tanggal
    connect_db()
    connection, cursor = connect_db()
    clear_terminal()
    print('1. Tampilkan seluruh Laporan')
    print('2. Tampilkan Laporan berdasarkan benih')
    print('3. Tampilkan Laporan berdasarkan 3 bulan terakhir')
    print('4. Kembali ke menu Customer')
    print()
    try:
      pilih = input('Masukkan menu yang ingin ditampilkan 1/2/3/4: ')
      if pilih == '1':
          print("\n" + "="*70)
          asix = '''
                  SELECT t.tanggal_transaksi, t.status_transaksi, t.metode_pembayaran, b.nama_benih
                  FROM transaksi t
                  JOIN detail_pesanan d ON d.id_pesanan = t.id_pesanan
                  join benih b ON d.id_benih = b.id_benih
            '''
          cursor.execute(asix)
          print()
          menu_admin(id_user)
      elif pilih == '2':
            aku = '''
                  SELECT t.tanggal_transaksi, t.status_transaksi, t.metode_pembayaran, b.nama_benih
                  FROM transaksi t
                  JOIN detail_pesanan d ON d.id_pesanan = t.id_pesanan
                  join benih b ON d.id_benih = b.id_benih
				          WHERE t.status_transaksi = 'Selesai'
                  GROUP BY b.nama_benih, t.tanggal_transaksi, t.status_transaksi, t.metode_pembayaran
            '''
            cursor.execute(aku)
            print()
            menu_admin(id_user)
      elif pilih == '3':
            kamu = '''
                  SELECT t.tanggal_transaksi, t.status_transaksi, t.metode_pembayaran, b.nama_benih
                  FROM transaksi t
                  JOIN detail_pesanan d ON d.id_pesanan = t.id_pesanan
                  join benih b ON d.id_benih = b.id_benih
                  WHERE t.tanggal_transaksi >= CURRENT_DATE - INTERVAL '3 months'
            '''
            cursor.execute(kamu)
            print()
            menu_admin(id_user)
      elif pilih == '4' :
        clear_terminal()
        menu_customer(id_user)
      else :
        print('=== PILIHAN TIDAK VALID ===')
    except Exception as e:
        print(f"Terjadi Error: {e}")
    print()
    print('=== DATA TIDAK VALID KEMBALI KE MENU ===')
    print()
    menu_admin(id_user)
    
def update_status_pengiriman(id_user):
    connect_db()
    connection, cursor = connect_db()
    try:
        print()
        print()
        print("=== UPDATE STATUS PENGIRIMAN ===")
        print()
        print('1. Update Status Pesanan')
        print('2. Kembali')
        pilih = input('Pilih Menu anda: ')
        if pilih == '1':
           aku = input('Pilih id yang akan di update: ')
           baru = input('pilih dikemas/dikirim/diterima/selesai: ').lower
           cursor.execute("""
                           UPDATE transaksi
                           SET status_transaksi
                           WHERE id_transaksi
                           """, baru, aku)
        elif pilih == '2':
            clear_terminal()
            menu_admin()
        else :
          print('=== PILIHAN TIDAK VALID ===')
    except Exception as e:
        print(f"Terjadi Error: {e}")
    print()
    print('=== DATA TIDAK VALID KEMBALI KE MENU ===')
    print()
    menu_admin(id_user)
    
# FITUR PRODUSEN
def cek_stok(id_user):
    connect_db()
    connection, cursor = connect_db()
    try:
        print()
        print()
        print("=== CEK STOK HABIS/KADALUARSA ===")
        print()
        print('1. Tampilkan Stok benih')
        print('2. Kembali ke menu customer')
        pilih = input('Pilih menu anda 1/2: ')
        if pilih == '1':
          query = """
                SELECT b.id_benih, b.nama_benih, b.kategori, b.harga, b.kadaluarsa,
                SUM(r.jumlah_produksi) as stok
                FROM benih b
                LEFT JOIN riwayat_produksi r ON b.id_benih = r.id_benih
                GROUP BY b.id_benih, b.nama_benih, b.kategori, b.harga, b.kadaluarsa
                ORDER BY b.kategori ASC
          """
          cursor.execute(query)   
          data = cursor.fetchall()
        elif pilih == '2':
          clear_terminal()
          menu_produsen()
        else:
          print('=== PILIHAN TIDAK VALID ===')
    except Exception as e:
        print(f"Terjadi Error: {e}")
    print()
    print('=== DATA TIDAK VALID KEMBALI KE MENU ===')
    print()
    menu_produsen(id_user)

# ========= QUERY SALAH
def update_benih(id_user):
    connection, cursor = connect_db()
    try:
        print("=== TAMPILKAN LAPORAN ===")
        query = """
            SELECT b.id_benih, b.nama_benih, b.kategori, b.harga,
            SUM(r.jumlah_produksi) as stok, b.kadaluarsa    
            FROM benih b
            JOIN riwayat_produksi r ON b.id_benih = r.id_benih
            GROUP BY b.id_benih, b.nama_benih, b.kategori, b.harga
            ORDER BY b.kategori, b.nama_benih
        """
        cursor.execute(query)   
        data = cursor.fetchall()
    except Exception as e:
        print(f"Terjadi Error: {e}")
    print()
    print('=== DATA TIDAK VALID KEMBALI KE MENU ===')
    print()
    menu_produsen(id_user)

# QUERY REVISI
def daftar_pesanan(id_user):
    connection, cursor = connect_db()
    print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
    print("‚ïë                    DAFTAR PESANAN                      ‚ïë")
    print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
    print()
    try:
        print(f"{'ID Pesanan':<12} {'ID User':<10} {'Benih':<10} {'Jumlah Pesanan':<15} {'Tanggal Pesan':<20}")
        print("-"*65)
    
        query = "SELECT id_pesanan, id_user, id_benih, jumlah_pesanan, tanggal_pesan FROM pesanan"
        cursor.execute(query)   
        results = cursor.fetchall()
        for row in results:
            print(f"{row[0]:<12} {row[1]:<10} {row[2]:<10} {row[3]:<15} {row[4]:<20}")
        print("-"*65)
    except Exception as e:
        print(f"Terjadi Error: {e}")
    print()
    print('=== DATA TIDAK VALID KEMBALI KE MENU ===')
    print()
    menu_produsen(id_user)

# MENU TIAP ROLE
def menu_admin(id_user):
    print()
    print("=== WELCOMEE ADMINN ===")
    print()
    print("1. Lihat Alur Pesanan")
    print("2. Tampilkan Laporan")
    print("3. Update Status Pengiriman")
    print("4. Keluar")
    try: 
        pilihan = input("Pilih menu (1/2/3/4): ")
        if pilihan == '1':
            lihat_alur_pesanan(id_user)
        elif pilihan == '2':
            generate_laporan(id_user)
        elif pilihan == '3':
            update_status_pengiriman(id_user)
        elif pilihan == '4':
            clear_terminal()
            print("Keluar dari menu admin.")
            print()
            gambar()
            dashboard()
        else:
            print()
            clear_terminal()
            print("Pilihan tidak valid. Silakan coba lagi.")
            menu_admin(id_user)
    except Exception as e :
     print(f"Terjadi Error: {e}")
  
def menu_customer(id_user):
    print()
    print("=== WELCOME CUSTOMERR ===")
    print()
    try:
        print("1. Katalog Benih")
        print("2. Keranjang Belanja")
        print("3. Ubah Alamat")
        print("4. Riwayat Transaksi")
        print("5. Keluar")
        print()
        pilih = input("Pilih Menu Customer: ")

        if pilih == "1":
            Katalog_Benih(id_user)
        elif pilih == "2":
            Keranjang_Belanja(id_user) 
        elif pilih == "3":
            Alamat(id_user)
        elif pilih == "4":
            Riwayat_Transaksi(id_user)
        elif pilih == "5":
            clear_terminal()
            print('Keluar dari menu Customer')
            print()
            gambar()
            dashboard()
        else :
            clear_terminal()
            print()
            print('=== PILIHAN TIDAK VALID ===')
            print()
            menu_customer(id_user)
    except Exception as e :
        print(f"Terjadi Error: {e}")
  
def menu_produsen(id_user):
    print()
    print("\n=== WELCOMEE PRODUSEN === ")
    print()
    print("1. Cek Stok Habis/Kadaluarsa")
    print("2. Update Stok Benih")
    print("3. Lihat Daftar Pesanan")
    print("4. Keluar")
    pilihan = input("Pilih menu (1/2/3/4): ")
    if pilihan == '1':
      cek_stok(id_user)
    elif pilihan == '2':
      update_benih(id_user)
    elif pilihan == '3':
      daftar_pesanan(id_user)
    elif pilihan == '4':
      clear_terminal()
      print('Keluar dari Menu Produsen')
      print()
      gambar()
      dashboard()
    else:
      clear_terminal()
      print()
      print("Pilihan tidak valid. Silakan coba lagi.")
      print()
      menu_produsen()

def gambar():
  print(""" 
  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà                        ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà             ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà‚ñà‚ñà                  
 ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà                      ‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà           ‚ñë‚ñë‚ñë      ‚ñë‚ñë‚ñà‚ñà‚ñà                   
‚ñë‚ñà‚ñà‚ñà    ‚ñë‚ñë‚ñë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà    ‚ñë‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 
‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà
 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñë  ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 
 ‚ñà‚ñà‚ñà    ‚ñë‚ñà‚ñà‚ñà‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë  ‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë  ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà    ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà      ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë  
‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 
 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  ‚ñë‚ñë‚ñë‚ñë‚ñë     ‚ñë‚ñë‚ñë‚ñë‚ñë  ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  
                                                                                ‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà         
                                                                               ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà          
                                                                                ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë                
      """)
  print('''
        SeedBridge adalah sebuah platform digital yang dirancang untuk menghubungkan PT. Benih Citra Asia, 
        para produsen benih, dan petani dalam satu ekosistem terpadu. Melalui aplikasi ini, seluruh proses 
        mulai dari penyediaan stok benih, pemesanan, distribusi, hingga pelacakan transaksi dapat dilakukan 
        secara real-time, lebih praktis, dan jauh lebih efisien dibanding cara manual.
        ''')

def dashboard():
    try:
      ds = input("Apakah sudah memiliki akun ? yes/no: ").lower()
      if ds == "yes":
        login()
      elif ds == "no":
        register()
      else :
        clear_terminal()
        gambar()
        print()
        print()
        print("=== INPUTAN TIDAK VALID ===")
        print("=== COBA LAGI ===")
        print()
        dashboard()
    except Exception as e :
        print(f"Terjadi Error: {e}")
  
def login():
    connection, cursor = connect_db()

    print("=== LOGIN AKUN ANDA ===")
    usn = input("Username: ")
    pw = input("Password: ")

    query = """
        SELECT id_user, id_role FROM users
        WHERE username = %s AND password = %s
    """
    cursor.execute(query, (usn, pw))
    result = cursor.fetchone()
    
    if not result:
        clear_terminal()
        gambar()
        print()
        print()
        print("=== USERNAME ATAU PASSWORD SALAH, COBA LAGI ===")
        login()
    
    id_user, id_role = result
    clear_terminal()
    gambar()    

    if id_role == 1:
        print("=== LOGIN BERHASIL SEBAGAI CUSTOMER ===")
        menu_customer(id_user) 
    elif id_role == 2:
        print("=== LOGIN BERHASIL SEBAGAI PRODUSEN ===")
        menu_produsen(id_user)
    elif id_role == 3:
        print("=== LOGIN BERHASIL SEBAGAI ADMIN ===")
        menu_admin(id_user)
    else:
        print("Role tidak dikenali.")
        return

# BIKIN AKUN BARU
def register():
    try: 
      print("1. Customer")
      print("2. Produsen")
      print("3. Admin")
      pilih = input("Pilih Akun Role yang ingin anda buat 1/2/3: ")

      if pilih == "1":
        role = 1
        data_customer(1)
      elif pilih == "2": 
        role = 2
        data_produsen(2)
      elif pilih == "3":
        role = 3
        data_admin(3)
      else :
        clear_terminal()
        gambar()
        print()
        print()
        print("=== INPUT TIDAK VALID COBA LAGI ===")
        print()
        return register()
    except Exception as e :
      print(f"Terjadi Error: {e}")

def data_customer(role):
    connection, cursor = connect_db()
    try:
      print()
      nama = input("Masukkan Nama: ")
      usn = input("Masukkan Username: ")
      if len(usn) > 8:
        print('Username tersimpan')
        print()
      else:
        clear_terminal()
        print("username harus lebih dari 8")
        print()

      cursor.execute("SELECT username FROM users WHERE username = %s", (usn,))
      if cursor.fetchone():
         clear_terminal()
         print("Username sudah terdaftar, gunakan yang lain.")

      pw = input("Masukkan Password:  ")
      if len(pw) > 8:
        print('Password tersimpan')
        print()
      else:
        clear_terminal()
        print("Password harus lebih dari 8. Silahkan Mulai Kembali")
        print()

      no_telp = input("Masukkan No. Telepon: ")
      if no_telp.isdigit() and len(no_telp) >= 10:
        print('No. Telepon tersimpan')
        print()
      else:
        clear_terminal()
        print("No. Telepon harus berupa angka dan minimal 10 digit. Silahkan Mulai Kembali")

      cursor.execute("SELECT no_telp FROM users WHERE no_telp = %s", (no_telp,))
      if cursor.fetchone():
        clear_terminal()
        print("No. Telepon sudah terdaftar. Silahkan Mulai Kembali")
    except Exception as e:
        print(f"Terjadi Error: {e}")

    query = """
        INSERT INTO users (nama, username, password, no_telp, id_role)
         VALUES (%s, %s, %s, %s, %s)
    """
    cursor.execute(query, (nama, usn, pw, no_telp, role))
    connection.commit()

    cursor.execute("SELECT id_user FROM users WHERE username = %s", (usn,))
    id_user = cursor.fetchone()[0]

    cursor.execute("""
        INSERT INTO keranjang_pesanan (id_user, quantity))
        VALUES (%s, 0)
    """, id_user)
    connnection.commit()

    gambar()
    print("=== Selamat Akun Anda Telah Dibuat ===")
    dashboard()
def data_produsen(role):
    connection, cursor = connect_db()
    try:
      print()
      nama = input("Masukkan Nama: ")
      usn = input("Masukkan Username: ")
      if len(usn) > 8 :
        print('Username tersimpan')
        print()
      elif usn in data_produsen:
        clear_terminal()
        print("Username sudah terdaftar. Silahkan Mulai Kembali")
        print()
      else :
        clear_terminal()
        print("username harus lebih dari 8")
        print()
        data_produsen(role)

      pw = input("Masukkan Password:  ")
      if len(pw) > 8 :
        print('Password tersimpan')
        print()
      else :
        clear_terminal()
        print("Password harus lebih dari 8. Silahkan Mulai Kembali")
        print()
        data_produsen(role)

      no_telp = input("Masukkan No. Telepon: ")
      if no_telp .isdigit() and len(no_telp) >= 10 :
        print('No. Telepon tersimpan')
        print()
      cursor.execute("SELECT no_telp FROM users WHERE no_telp = %s", (no_telp,))
      if cursor.fetchone():
        clear_terminal()
        print("No. Telepon sudah terdaftar. Silahkan Mulai Kembali")
      else :
        clear_terminal()
        print("No. Telepon harus berupa angka dan minimal 10 digit. Silahkan Mulai Kembali")
        data_produsen(role)
    except Exception as e :
      print(f"Terjadi Error: {e}")

    query = """
        INSERT INTO users (nama, username, password, no_telp, id_role)
         VALUES (%s, %s, %s, %s, %s)
    """
    cursor.execute(query, (nama, usn, pw, no_telp, role))
    connection.commit()

    cursor.execute("SELECT id_user FROM users WHERE username = %s", (usn,))
    id_user = cursor.fetchone()[0]

    cursor.execute("""
        INSERT INTO keranjang_pesanan (id_user, quantity))
        VALUES (%s, 0)
    """, id_user)
    connnection.commit()
    gambar()
    print("=== Selamat Akun Anda Telah Dibuat ===")
    dashboard()

gambar()
print("=== WELCOME TO OUR PLATFORM ===")
print()
print()
dashboard()
