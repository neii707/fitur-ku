def connect_db():
    try:
        connection = psycopg2.connect(user="postgres",
                                      password="neina776",
                                      host="127.0.0.1",
                                      port="5432",
                                      database="Project")
        cursor = connection.cursor()
        return connection, cursor
    except (Exception, Error) as error:
        return None, None
def commit_db(connection, cursor):
    try:
        connection.commit()
        affected = cursor.rowcount  # jumlah baris yang terpengaruh
        return affected > 0         # True/False
    except Exception as e:
        print("Error saat commit:", e)
        connection.rollback()
        return False
    finally:
        try:
            cursor.close()
            connection.close()
        except:
            pass

def clear_terminal():
    os.system('cls')
# FITUR CUSTOMER
def Katalog_Benih(id_user):
    connection, cursor = connect_db()
    clear_terminal()
    print()
    print('1. Tampilkan semua Katalog Menu')
    print()
    print("  Filter Berdasarkan Kategori ")
    print("2. Harga Terendah")
    print("3. Harga Tertinggi")
    print("4. Stok Tersedia")
    print("5. Kembali ke Menu Customer")
    print()
    pilih = input('Pilih Menu anda 1/2/3/4/5/6: ')
    
    QUERY_BASE = """
        SELECT
        b.id_benih, b.nama_benih, k.nama_kategori, b.harga, r.tanggal_kadaluarsa,
        SUM(r.jumlah_produksi) as stok    
        FROM benih b
        JOIN kategori_benih k ON b.id_kategori_benih = k.id_kategori_benih
        LEFT JOIN riwayat_produksi r ON b.id_benih = r.id_benih
        GROUP BY b.id_benih, b.nama_benih, k.nama_kategori, b.harga, r.tanggal_kadaluarsa 
    """
    
    try: 
        if pilih == '1':
            query = QUERY_BASE
        elif pilih == "2":
            query = QUERY_BASE + " ORDER BY b.harga ASC"    
        elif pilih == "3":
            query = QUERY_BASE + " ORDER BY b.harga DESC"
        elif pilih == "4":
            query =  """
            SELECT
            b.id_benih, b.nama_benih, k.nama_kategori, b.harga, r.tanggal_kadaluarsa,
            SUM(r.jumlah_produksi) as stok    
            FROM benih b
            JOIN kategori_benih k ON b.id_kategori_benih = k.id_kategori_benih
            LEFT JOIN riwayat_produksi r ON b.id_benih = r.id_benih
            GROUP BY b.id_benih, b.nama_benih, k.nama_kategori, b.harga, r.tanggal_kadaluarsa 
            HAVING SUM(r.jumlah_produksi) > 0 
            ORDER BY b.nama_benih ASC
        """
        elif pilih == "5":
            clear_terminal()
            return menu_customer(id_user)
        else:
            print("Pilihan tidak valid.")
            return Katalog_Benih(id_user)

        if pilih in ['1', '2', '3', '4']:
            cursor.execute(query)
            data = cursor.fetchall()
        else:
            data = []

        clear_terminal()
        print("\n" + "="*75)
        print("                   ðŸŒ± KATALOG BENIH ðŸŒ±")
        print("="*75)
        print("="*75)
        print("     Gunakan ID Benih untuk menambahkan ke keranjang belanja Anda.")
        print("="*75)

        if not data:
            if pilih in ['1', '2', '3', '4']:
                print("Belum ada benih yang tersedia.")
            
            print("="*75 + "\n")
            return menu_customer(id_user)
            
        kategori_sekarang = None

        for row in data:
            id_benih, nama_benih, nama_kategori, harga, kadaluarsa, stok = row

            if nama_kategori != kategori_sekarang:
                kategori_sekarang = nama_kategori
                print(f"\nðŸ“‚ Kategori: {nama_kategori}")
                print("-"*75)
                print(f"{'ID Benih':^10} {'Nama Benih':^25} {'Harga':^10} {'Tanggal Kadaluarsa':^20} {'Stok':^7}")
                print("-"*75)
            
            if kadaluarsa is not None:
                tanggal_str = kadaluarsa.strftime("%Y-%m-%d")
            else:
                tanggal_str = "N/A"
                
            stok_display = stok if stok is not None else 0
            
            id_benih_display = id_benih if id_benih is not None else ""
            nama_benih_display = nama_benih if nama_benih is not None else ""
            harga_display = harga if harga is not None else ""

            print(f"{id_benih_display:^10} {nama_benih_display:^25} {harga_display:^10} {tanggal_str:^20} {stok_display:^7}")
            
            stok = stok_display
            
        print()
        kelas = input('pilih 1 untuk kembali dan 2 untuk pilih benih: ')
        if kelas == '1':
          clear_terminal()
          Katalog_Benih(id_user)
        elif kelas == '2':
          connection, cursor = connect_db()
          aku = input('masukkan id benih yg mau dibeli: ')
          kmu = input('masukkan jumlah benih yg dibeli: ')

          sql_get_keranjang = "SELECT id_keranjang FROM users WHERE id_user = %s"
          cursor.execute(sql_get_keranjang, (id_user,))
          result = cursor.fetchone()
            

          if result:
            id_keranjang = result[0]
          else:
            # keranjang baru 
            sql_create_keranjang = """
            INSERT INTO keranjang (id_user, status, created_at) 
            VALUES (%s, 'active', NOW()) 
            RETURNING id_keranjang
            """
            cursor.execute(sql_create_keranjang, (id_user,))
            id_keranjang = cursor.fetchone()[0]
            print(f"Keranjang baru dibuat: {id_keranjang}")

          sql_detail = """
                        INSERT INTO detail_keranjang (id_keranjang, id_benih, quantity)
                        VALUES (%s, %s, %s)
                        """
                        
          cursor.execute("SELECT id_keranjang FROM users WHERE id_user = %s", (id_user,))
          keranjang = cursor.fetchone()                
                        
          data_detail = (id_keranjang, aku, kmu) 
          cursor.execute(sql_detail, data_detail)
          connection.commit()  
          print()
          print()
          print()
          
          pergi = input('Benih sudah dimasukkan ke keranjang silahkan tekan enter untuk pergi ke menu keranjang')
          if pergi == '':
            clear_terminal()
            Keranjang_Belanja(id_user)
          else :
            clear_terminal()
            print('PILIHAN TIDAK VALID KEMBALI KE MENU CUSTOMER')
            menu_customer(id_user)
          

    except Exception as e :
        print(f"Terjadi Error: {e}")
        print()
        print('=== DATA TIDAK VALID KEMBALI KE MENU ===')
        print()
        menu_customer(id_user)
        print()
    finally:
        commit_db(connection, cursor)

def Keranjang_Belanja(id_user):
    id_pesanan_baru = None
    connection, cursor = connect_db()
    
    print()
    print('1. Tampilkan Keranjang Belanja')
    print('2. Kembali Menu Customer')
    pilih = input('Pilih Menu anda 1/2: ')
    try:
      if pilih == '1':
            clear_terminal()
            print("===============================               WELCOME TO KERANJANG               ===============================")
            print()
            query = """
                SELECT d.id_detail_keranjang, b.nama_benih, b.harga, d.quantity, (b.harga * d.quantity) AS total_harga
                FROM detail_keranjang d
                JOIN benih b ON d.id_benih = b.id_benih
                WHERE d.id_keranjang = %s
                ORDER BY d.id_detail_keranjang 
            """
            cursor.execute(query, (id_user,))
            results = cursor.fetchall()

            if not results:
                print()
                print("Keranjang belanja Anda kosong.")
                return menu_customer(id_user)
    
            for row in results:
                print("===============================          Detail Keranjang Belanja Anda           ===============================")
                print()
                print(f"ID DETAIL   : {row[0]}       Nama Benih   : {row[1]}     harga: {row[2]}    Jumlah: {row[3]}     Total Harga: {row[4]}")
                print()
                print("================================================================================================================")  
            print()
            keranjang = []
            total_semua = 0
            keranjang.append({
            'id_detail': row[0],
            'nama_benih': row[1],
            'harga': row[2],
            'jumlah': row[3],
            'total_harga': row[4]
              })
            print(f"{'TOTAL KERANJANG':<100} Rp {row[4]:>}")
            print("="*112)
            
            print("\nMasukkan ID DETAIL yang ingin dibeli (pisahkan dengan spasi):")
            try:
                pilihan = input(">>:  ").strip()
                if not pilihan:
                  print("Tidak ada item yang dipilih!")
                  return pilihan
            
                id_detail = [int(x.strip()) for x in pilihan.split()]
                
                dipilih = [item for item in keranjang if int(str(item['id_detail']).strip()) in id_detail]
                
                if not dipilih:
                    print("Tidak ada item yang valid dipilih!")
                    clear_terminal()
                    pilihan
                
                print(f"\nâœ… {len(dipilih)} item dipilih untuk checkout!")
                print("\n" + "="*100)
                print(" " * 40 + "ðŸ›’ CHECKOUT")
                print("="*100)
                print(f"{'ID':<8} {'NAMA BENIH':<25} {'HARGA':<12} {'QTY':>4} {'SUB TOTAL':>15}")
                print("-" * 100)
                    
                total_bayar = 0
                for item in dipilih:
                    print(f"{item['id_detail']:<8} {item['nama_benih']:<25} Rp {item['harga']:>3} {item['jumlah']:>7}        Rp {item['total_harga']:>7}")
                    total_bayar += item['total_harga']
                    print()
                    print("-" * 100)
                    print(f"{'TOTAL YANG HARUS DIBAYAR':<58} Rp {total_bayar:>3}")
                    print("="*100)
                    
                    cursor.execute("SELECT id_keranjang FROM users WHERE id_user = %s", (id_user,))
                    keranjang = cursor.fetchone()
                    if not keranjang:
                        print(" Keranjang tidak ditemukan!")
                    
                    print("\n" + "="*50)
                    print("INFORMASI PENGIRIMAN & PEMBAYARAN")
                    print("="*50)
                    
                    metode_pembayaran = input("Metode Pembayaran tunai/non tunai): ").strip().lower()
                    
                    if not metode_pembayaran :
                        print(" Metode pembayaran wajib diisi!")
                        metode_pembayaran
                    
                    konfir = input('Anda yakin ingin untuk Membeli item ini ? ya/tidak: ').strip().lower()
                    if konfir == 'ya':
                      id_pesanan = """
                                  INSERT INTO pesanan (tanggal_pesanan, id_user)
                                  VALUES (NOW(), %s)
                                  RETURNING id_pesanan;
                                  """
                      data_pesan = (id_user,)
                      cursor.execute(id_pesanan, data_pesan)
                    
                      result = cursor.fetchone()
                      id_pesanan_baru = result[0]

                      list = [item['id_detail'] for item in dipilih]
                      for id_detail_keranjang in list:
                        info = """
                                          SELECT id_benih, quantity
                                          FROM detail_keranjang
                                          WHERE id_detail_keranjang = %s
                                          """
                        cursor.execute(info, (id_detail_keranjang,))
                        item_data = cursor.fetchone()
                        
                        if item_data:
                            id_benih_beli = item_data[0]
                            qty_dibeli = item_data[1]
                            

                            sql_update_stok = """
                                              UPDATE riwayat_produksi
                                              SET jumlah_produksi = jumlah_produksi - %s
                                              WHERE id_benih = %s;
                                  """
                            cursor.execute(sql_update_stok, (qty_dibeli, id_benih_beli))
                            print(f"DEBUG: Mencoba UPDATE Benih ID {id_benih_beli} sebanyak {qty_dibeli}.")
                      
                      hold = ', '.join(['%s'] * len(id_detail))
                      sql_delete = f"""
                      DELETE FROM detail_keranjang
                      WHERE id_detail_keranjang = ({hold});
                                  """
                      cursor.execute(sql_delete, tuple(id_detail))
                      print()
                      print("="*50)
                      print("PEMBELIAN BERHASIL!")
                      print(f" No. Pesanan: #{id_pesanan_baru}")
                      print(f" Total: Rp {total_bayar}")
                      print("ðŸ›’ Keranjang sekarang KOSONG") 
                      print()
                      pergi = input('Silahkan tekan enter untuk pergi kembali ke menu customer')
                      if pergi == '':
                        clear_terminal()
                        menu_customer(id_user)
                      else :
                        clear_terminal()
                        print('PILIHAN TIDAK VALID KEMBALI KE MENU CUSTOMER')
                        menu_customer(id_user)
            except ValueError:
                  print(" Input tidak valid! Harus angka.")
                  clear_terminal()
                  pilihan
    except Exception as e :
        print(f"Terjadi Error: {e}")
        print('=== DATA TIDAK VALID KEMBALI KE MENU ===')
        print()
        menu_customer(id_user)
    finally:
        commit_db(connection, cursor)
        print()

def Riwayat_Transaksi(id_user):
    connect_db()
    connection, cursor = connect_db()
    print()
    print('1. Tampilkan Fitur Transaksi')
    print('2. Kembali Menu Customer')
    pilih = input('Pilih Menu anda 1/2: ')
    try:
      clear_terminal()
      if pilih == '1':
          # checkout detail = join
          query = """
                  SELECT t.tanggal_transaksi, b.nama_benih, d.quantity, d.quantity*b.harga AS Total_bayar,
                        k.nama, c.nama, s.nama
                  FROM transaksi t
                  JOIN detail_pesanan d ON d.id_pesanan = t.id_pesanan
                  JOIN pesanan p ON p.id_pesanan = d.id_pesanan
                  JOIN benih b ON b.id_benih = d.id_benih 
                  JOIN users u ON p.id_user = u.id_user  
                  JOIN alamat a ON u.id_user = a.id_user
                  JOIN desa s ON a.id_desa = s.id_desa
                  JOIN kecamatan c ON s.id_kecamatan = c.id_kecamatan
                  JOIN kabupaten k ON c.id_kabupaten = k.id_kabupaten
                  WHERE p.id_user = %s
                  ORDER BY t.tanggal_transaksi DESC, t.id_transaksi;
          """
          cursor.execute(query, (id_user,))
          results = cursor.fetchall()
          print()
          print("=== WELCOME TO RIWAYAT TRANSAKSI ===")
          print()
          if not results:
              print()
              print("Tidak ada riwayat transaksi.")
              print()
              menu_customer(id_user)
          else:
              for row in results:
                tanggal = str(row[0]) 
                nama = row[1]
                qty = row[2]
                harga = row[3]
                kabupaten = row[4]
                kecamatan = row[5]
                desa = row [6]

                print(f"| {tanggal:<10} | {nama:<20} | {qty:<5} | {harga:<10} | {kabupaten:<15} | {kecamatan:<15} | {desa:<15} |")
                print("-" * 65)
      
          balik = input('Tekan enter untuk kembali ke menu customer')
          if balik == '':
            clear_terminal()
            menu_customer(id_user)
          else :
            menu_customer(id_user)
      
      elif pilih == '2':
        menu_customer(id_user)
      
      else:
        print('=== PILIHAN TIDAK VALID ===')
    except Exception as e :
        print(f"Terjadi Error: {e}")
    finally:
          commit_db(connection, cursor)
    print()
    print()
